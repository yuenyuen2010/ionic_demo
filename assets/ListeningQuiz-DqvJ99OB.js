import{u as R,r as o,j as e,I as _,b as B,c as h,e as H}from"./index-BZSl7NkZ.js";import{o as G,v as q,E as z,F,r as J,h as U}from"./index-CEQkXYGf.js";import{C as D}from"./CommonHeader-C0bULxfv.js";import{l as K}from"./lessons-DH3gilkg.js";const V=()=>{const n=[];return K.forEach(a=>{a.cards.forEach(i=>{i.tagalog.split(" ").length<=3&&n.push({tagalog:i.tagalog,english:i.english})})}),n},T=n=>{const a=[...n];for(let i=a.length-1;i>0;i--){const p=Math.floor(Math.random()*(i+1));[a[i],a[p]]=[a[p],a[i]]}return a},u=10,se=()=>{const{t:n}=R(),a=o.useRef(null),[i,p]=o.useState([]),[g,A]=o.useState(0),[x,E]=o.useState(0),[d,y]=o.useState(null),[m,b]=o.useState(null),[w,I]=o.useState(!1),[j,f]=o.useState(!1),[N,C]=o.useState(!1),P=o.useCallback(()=>{const s=V();return T(s).slice(0,u).map(c=>{const v=T(s.filter(L=>L.tagalog!==c.tagalog)).slice(0,3),k=T([c,...v]);return{word:c,options:k}})},[]),S=o.useCallback(()=>{const s=P();p(s),A(0),E(0),y(null),b(null),I(!1),C(!1)},[P]);o.useEffect(()=>{S()},[S]);const r=i[g],O=async()=>{var l;if(!r||j)return;f(!0),C(!0);const s=r.word.tagalog;try{const v=(l=(await(await fetch("/ionic_demo/audio/audio-map.json")).json())[s])==null?void 0:l.normal;if(v){const k="/ionic_demo/".concat(v);if(a.current){a.current.src=k,a.current.onended=()=>f(!1),a.current.onerror=()=>{console.log("Local audio failed, trying Cloud TTS"),$(s)},await a.current.play();return}}else console.log("No local audio found, trying Cloud TTS")}catch(t){console.log("Audio map fetch failed:",t)}$(s)},$=async s=>{try{const l=await fetch("https://tts-server-479744148035.asia-east1.run.app/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:s,languageCode:"fil-PH",voiceName:"fil-PH-Standard-A"})});if(l.ok){const t=await l.json();if(t.audioContent){const c=new Audio("data:audio/mp3;base64,".concat(t.audioContent));c.onended=()=>f(!1),c.onerror=()=>f(!1),c.play();return}}}catch(l){console.error("Cloud TTS failed:",l)}f(!1)};o.useEffect(()=>{if(r&&!w){const s=setTimeout(()=>{O()},500);return()=>clearTimeout(s)}},[g,i]);const M=s=>{if(d!==null||!N)return;y(s);const l=s===r.word.tagalog;b(l),l&&E(t=>t+1),setTimeout(()=>{g+1>=u?I(!0):(A(t=>t+1),y(null),b(null),C(!1))},2e3)},Q=()=>{const s=x/u*100;return s===100?"üèÜ":s>=80?"üåü":s>=60?"üòä":s>=40?"üí™":"üìö"},W=()=>{const s=x/u*100;return s===100?n("listening.perfect"):s>=80?n("listening.excellent"):s>=60?n("listening.good"):s>=40?n("listening.keepLearning"):n("listening.tryAgain")};return!r&&!w?null:e.jsxs(_,{children:[e.jsx(D,{title:n("listening.title"),showBackButton:!0,defaultHref:"/home"}),e.jsx("audio",{ref:a}),e.jsx(B,{className:"listening-game-content",children:w?e.jsx("div",{className:"listening-game-over",children:e.jsxs("div",{className:"game-over-card",children:[e.jsx("div",{className:"score-emoji",children:Q()}),e.jsx("h2",{className:"score-title",children:W()}),e.jsx("div",{className:"final-score",children:e.jsxs("div",{className:"score-circle",children:[e.jsx("span",{className:"score-number",children:x}),e.jsxs("span",{className:"score-total",children:["/ ",u]})]})}),e.jsxs("div",{className:"game-over-actions",children:[e.jsxs(H,{expand:"block",onClick:S,className:"play-again-btn",children:[e.jsx(h,{icon:J,slot:"start"}),n("listening.playAgain")]}),e.jsxs(H,{expand:"block",fill:"outline",routerLink:"/home",className:"home-btn",children:[e.jsx(h,{icon:U,slot:"start"}),n("common.backToHome")]})]})]})}):e.jsxs("div",{className:"listening-game-container",children:[e.jsx("div",{className:"listening-progress-bar",children:e.jsx("div",{className:"listening-progress-fill",style:{width:"".concat((g+1)/u*100,"%")}})}),e.jsxs("div",{className:"listening-stats-row",children:[e.jsxs("div",{className:"listening-stat",children:[e.jsx("span",{className:"stat-label",children:n("listening.question")}),e.jsxs("span",{className:"stat-value",children:[g+1,"/",u]})]}),e.jsxs("div",{className:"listening-stat",children:[e.jsx("span",{className:"stat-label",children:n("listening.score")}),e.jsx("span",{className:"stat-value",children:x})]})]}),e.jsxs("div",{className:"audio-player-card",children:[e.jsx("button",{className:"play-audio-btn ".concat(j?"playing":""),onClick:O,disabled:j,children:e.jsx(h,{icon:j?G:q})}),e.jsx("p",{className:"audio-hint",children:n(N?"listening.tapAgain":"listening.tapToListen")})]}),e.jsx("div",{className:"listening-options-grid",children:r.options.map((s,l)=>{let t="listening-option";return d!==null&&(s.tagalog===r.word.tagalog?t+=" correct":s.tagalog===d&&!m?t+=" wrong":t+=" faded"),N||(t+=" disabled"),e.jsxs("button",{className:t,onClick:()=>M(s.tagalog),disabled:d!==null||!N,children:[e.jsx("span",{className:"option-tagalog",children:s.tagalog}),e.jsx("span",{className:"option-english",children:s.english}),d!==null&&s.tagalog===r.word.tagalog&&e.jsx(h,{icon:z,className:"result-icon correct"}),d===s.tagalog&&!m&&e.jsx(h,{icon:F,className:"result-icon wrong"})]},l)})}),d!==null&&e.jsxs("div",{className:"listening-feedback ".concat(m?"correct":"wrong"),children:[e.jsx("span",{className:"feedback-emoji",children:m?"‚úÖ":"‚ùå"}),e.jsx("span",{className:"feedback-text",children:m?n("listening.correct"):"".concat(n("listening.wrong")," ").concat(r.word.tagalog)})]})]})})]})};export{se as default};
